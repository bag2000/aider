# Task Runner System with Healthchecks Monitoring

Система для автоматизации выполнения задач (скриптов, резервного копирования, обслуживания) с интеграцией мониторинга через [Healthchecks.io](https://healthchecks.io).

## Текущее состояние

На данный момент реализована **инициализация чеков Healthchecks** на основе конфигурационного файла. Это позволяет автоматически создавать мониторинговые точки для всех задач, которые будут выполняться в будущем.

В дальнейшем система будет расширена для:
- Запуска различных типов скриптов (не только резервное копирование)
- Управления расписанием выполнения
- Обработки зависимостей между задачами
- Расширенного логирования и уведомлений

## Быстрый старт

### 1. Установка зависимостей

Система написана на Python 3.9+. Убедитесь, что установлены необходимые библиотеки:

```bash
pip install requests pyyaml
```

### 2. Настройка конфигурации

Основной конфигурационный файл — `init.conf` (формат YAML).

#### Секция `general`
```yaml
general:
  server_name: "server-01"       # Имя сервера (используется в slug чеков)
  base_url: "https://healthchecks.io/api/v1/checks/"   # URL API Healthchecks
  ping_base: "https://hc-ping.com"                     # Базовый URL для ping
  channels: ""                   # ID каналов уведомлений через запятую
```

#### Секция `tasks`
Список задач, которые будут мониториться. Каждая задача содержит:

```yaml
- name: "Описание задачи"
  slug: "уникальный-идентификатор"  # Будет объединён с server_name
  tag: "тег1 тег2"                  # Теги для Healthchecks
  enable: true                      # Включена ли задача
  # Дополнительные поля в зависимости от типа задачи
```

Примеры задач для резервного копирования БД уже присутствуют в файле.

### 3. Инициализация чеков в Healthchecks

Для создания чеков выполните:

```bash
python init_checks.py <API_TOKEN>
```

Где `<API_TOKEN>` — ваш API-ключ Healthchecks (можно получить в настройках проекта).

Опционально можно указать другой URL API:

```bash
python init_checks.py <API_TOKEN> --base-url https://ваш.сервер/api/v1/checks/
```

**Что происходит при инициализации:**
1. Загружается конфигурация из `init.conf`
2. Для каждой включённой задачи (`enable: true`) создаётся чек в Healthchecks с параметрами:
   - **slug**: `{server_name}-{task_slug}`
   - **name**: совпадает со slug
   - **tags**: из поля `tag` задачи
   - **timeout**: 3600 секунд
   - **grace**: 60 секунд
   - **channels**: из общего настроя `channels`
3. Если чек с таким slug уже существует, он не создаётся повторно (идемпотентность)

### 4. Использование в своих скриптах

В скриптах, которые выполняют задачи, используйте функции из `hc.py` для отправки статусов:

```python
from hc import ping_start, ping_success, ping_fail

# Ping URL можно получить из результата инициализации
# или сформировать: {ping_base}/{uuid}
ping_url = "https://hc-ping.com/ваш-uuid"

try:
    ping_start(ping_url, data="Задача начата")
    # ... выполнение основной логики ...
    ping_success(ping_url, data="Успешное завершение")
except Exception as e:
    ping_fail(ping_url, data=f"Ошибка: {e}")
    raise
```

## Архитектура

### Модули

- **`config_manager.py`** — загрузка и парсинг конфигурации YAML
- **`hc.py`** — взаимодействие с API Healthchecks (создание чеков, отправка ping)
- **`init_checks.py`** — скрипт инициализации чеков
- **`main.py`** — основной скрипт (в будущем будет запускать задачи)

### Конфигурация

Конфигурация построена вокруг понятия **задачи** (task). Каждая задача имеет:
- Уникальный идентификатор (slug)
- Статус включения (enable)
- Произвольные параметры для исполнителя

В будущем планируется добавить:
- Поле `type` для определения обработчика задачи
- Поле `schedule` для расписания выполнения
- Поле `dependencies` для указания зависимостей

## Планы по развитию

### 1. Запуск задач (ближайшая цель)

Расширить `main.py` для:
- Чтения конфигурации
- Определения, какие задачи нужно запустить (по расписанию или вручную)
- Вызова соответствующих исполнительных модулей
- Обработки результатов и отправки ping-сигналов

### 2. Исполнительные модули

Создать плагины для различных типов задач:
- **backup_db** — резервное копирование БД (уже частично реализовано в конфигурации)
- **shell_command** — выполнение произвольной shell-команды
- **python_script** — запуск Python-скрипта
- **http_check** — проверка доступности HTTP-ресурса

### 3. Расписание

Добавить поддержку cron-like выражений для автоматического запуска:

```yaml
- name: "Ежедневный бекап"
  slug: "daily-backup"
  type: "backup_db"
  schedule: "0 2 * * *"   # Каждый день в 02:00
  enable: true
```

### 4. Мониторинг и логирование

- Расширенное логирование в файлы с ротацией
- Интеграция с системами сбора логов (ELK, Loki)
- Дашборд для просмотра статуса выполнения задач

### 5. Безопасность

- Шифрование чувствительных данных в конфигурации
- Поддержка секретов из внешних хранилищ (HashiCorp Vault, AWS Secrets Manager)
- Аудит выполненных операций

## Пример будущей конфигурации

```yaml
general:
  server_name: "prod-server"
  base_url: "https://healthchecks.io/api/v1/checks/"
  ping_base: "https://hc-ping.com"
  channels: "email-alerts,slack-notifications"

tasks:
  - name: "Резервное копирование PostgreSQL"
    slug: "postgres-backup"
    type: "backup_db"
    db_type: "postgres"
    schedule: "0 1 * * *"
    enable: true

  - name: "Очистка временных файлов"
    slug: "cleanup-temp"
    type: "shell_command"
    command: "rm -rf /tmp/*"
    schedule: "0 4 * * *"
    enable: true

  - name: "Проверка доступности API"
    slug: "api-health"
    type: "http_check"
    url: "https://api.example.com/health"
    expected_status: 200
    schedule: "*/5 * * * *"
    enable: true
```

## Участие в разработке

Система находится в активной разработке. Предложения и pull requests приветствуются.

1. Форкните репозиторий
2. Создайте ветку для вашей функции
3. Внесите изменения
4. Добавьте тесты
5. Отправьте pull request

## Лицензия

MIT License.
