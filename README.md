# Система резервного копирования БД с Healthchecks

Этот проект предоставляет набор скриптов для автоматического резервного копирования баз данных (PostgreSQL, MySQL) с отправкой уведомлений в [Healthchecks.io](https://healthchecks.io).

## Возможности

- Резервное копирование БД через sudo (локально) или через Docker
- Автоматическая инициализация чеков в Healthchecks для мониторинга
- Отправка ping-сигналов (start, success, fail) для отслеживания выполнения задач
- Ротация логов с использованием Loguru
- Гибкая конфигурация через YAML-файл

## Требования

- Python 3.9 или выше
- Рекомендуется использовать виртуальное окружение (venv)

## Установка

1. Клонируйте репозиторий или скопируйте файлы проекта.

2. Создайте виртуальное окружение:

```bash
python3 -m venv venv
```

3. Активируйте виртуальное окружение:

- Для Linux/macOS:
  ```bash
  source venv/bin/activate
  ```
- Для Windows (PowerShell):
  ```powershell
  venv\Scripts\activate
  ```

4. Установите зависимости:

```bash
pip install -r requirements.txt
```

Если вы не хотите использовать виртуальное окружение, установите зависимости глобально:

```bash
pip3 install --break-system-packages -r requirements.txt
```

**Примечание:** Использование `--break-system-packages` может потребоваться в некоторых системах, где pip по умолчанию работает в изолированном режиме. Рекомендуется использовать виртуальное окружение.

## Конфигурация

Перед запуском необходимо настроить файл `init.conf`. Основные параметры:

### Секция `general`

```yaml
general:
  backup_path: "/bak/db"         # Директория для хранения резервных копий
  server_name: "server-01"       # Имя сервера (будет добавлено к slug чеков)
  base_url: "https://hc.t8.ru/api/v1/checks/"   # Базовый URL API Healthchecks
  ping_base: "https://hc.t8.ru/ping/qpljt3jgl2inp8lkya6h1a/"   # Базовый URL для ping-сигналов
  channels: "uuid1,uuid2"        # Идентификаторы каналов уведомлений через запятую
```

### Секция `tasks`

Каждая задача должна содержать:

```yaml
- name: "Postgres Local Main"
  slug: "db-backup-postgres-1"   # Уникальный идентификатор задачи
  tag: "postgres db backup"      # Теги для чеков (через пробел)
  db_type: "postgres"            # Тип БД (postgres, mysql)
  container_name: ""             # Имя контейнера Docker (пусто для локального выполнения)
  bin_path: "/usr/bin/pg_dumpall" # Путь к утилите резервного копирования
  db_user: "postgres"            # Пользователь БД
  sys_user: "postgres"           # Системный пользователь для выполнения
  output_file: "dump.sql.gz"     # Имя выходного файла
  enable: true                   # Включена ли задача
```

## Быстрый старт

1. Настройте файл `init.conf` под ваше окружение (укажите пути, пользователей, настройки Healthchecks).

2. (Опционально) Инициализируйте чеки Healthchecks (делается один раз):

```bash
python3 init_checks.py <API_токен>
```

Опционально можно указать другой базовый URL API:

```bash
python3 init_checks.py <API_токен> --base-url "https://healthchecks.io/api/v1/checks/"
```

3. Запустите резервное копирование:

```bash
python3 main.py
```

Скрипт автоматически:
- Прочитает конфигурацию из `init.conf`
- Выполнит резервное копирование для всех включённых задач
- Отправит ping-сигналы в Healthchecks (start, success/fail)
- Запишет логи в `logs/backup_db.log`

## Структура проекта

- `main.py` — основной скрипт для запуска резервного копирования.
- `backup_db.py` — скрипт резервного копирования БД.
- `init_checks.py` — скрипт инициализации чеков Healthchecks (запускается один раз).
- `config_manager.py` — модуль для работы с конфигурацией `init.conf`.
- `hc.py` — вспомогательные функции для взаимодействия с API Healthchecks.
- `shell_manager.py` — модуль для безопасного выполнения shell-команд.
- `logger_manager.py` — менеджер логирования на основе Loguru.
- `init.conf` — конфигурационный файл (пример).
- `requirements.txt` — список зависимостей Python.
- `.gitignore` — список игнорируемых файлов Git.
- `logs/` — директория для логов (файлы логов игнорируются Git, сохраняется структура через `.gitkeep`).

## Обработка ошибок

- Если файл `init.conf` не найден или содержит синтаксические ошибки YAML, скрипт завершится с сообщением об ошибке.
- Если отсутствует секция `general` или `tasks`, скрипт также завершится с ошибкой.
- При проблемах с сетью или API Healthchecks ошибка будет выведена в stderr, но скрипт продолжит обработку остальных задач.
- Команды резервного копирования проверяются на наличие ошибок в stderr, даже при нулевом коде возврата.

## Безопасность

- API токен передаётся как аргумент командной строки, что может оставить его в истории команд. Рекомендуется использовать переменные окружения или файлы с ограниченными правами.
- Конфигурационный файл `init.conf` может содержать чувствительные данные (например, URL с ping-токенами). Убедитесь, что права на чтение ограничены.
- Скрипт использует sudo для выполнения команд от имени других пользователей. Убедитесь, что настройки sudoers безопасны.

## Проверка чек-листа (Dangerous Areas Checklist)

Перед запуском в production убедитесь в следующем:

1. **Права и пользователь** — скрипт выполняется от пользователя с доступом к чтению `init.conf` и без излишних привилегий.
2. **Окружение** — убедитесь, что `base_url` и `ping_base` указывают на правильный экземпляр Healthchecks (prod/stage/dev).
3. **Секреты и креды** — API токен не попадает в логи или вывод скрипта.
4. **Ошибки и исключения** — скрипт корректно обрабатывает сетевые сбои и не завершается аварийно для всех задач при единичной ошибке.
5. **Идемпотентность** — повторный запуск безопасен: существующие чеки не будут дублироваться, резервные копии перезаписываются (ожидаемое поведение).

## Дальнейшие действия

После успешной инициализации чеков можно настроить задачи резервного копирования для отправки ping-сигналов (start/success/fail) в соответствующие ping URL. Пример использования функций из `hc.py`:

```python
from hc import ping_start, ping_success

ping_url = "https://hc.t8.ru/ping/qpljt3jgl2inp8lkya6h1a/server-01-db-backup-postgres-1"
ping_start(ping_url)
# ... выполнение задачи резервного копирования ...
ping_success(ping_url)
```

Для автоматизации можно добавить скрипт в cron:

```bash
# Пример записи в crontab (запуск каждый день в 2:00)
0 2 * * * cd /path/to/project && /path/to/venv/bin/python3 main.py
```

---
*Этот документ охватывает полную документацию по настройке и использованию системы резервного копирования.*
