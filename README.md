# Модульная система бэкапа на Bash с использованием Restic

Эта система бэкапа реорганизована в модульную структуру для удобства управления и поддержки.

## Структура проекта

```
.
├── main.sh              # Главный диспетчер (точка входа)
├── init.conf            # Общие настройки
├── restic_backup.sh     # Модуль бэкапа
├── restic_forget.sh     # Модуль чистки бэкапа
└── README.md            # Документация
```

## Настройка

### 1. Конфигурация (init.conf)

Отредактируйте файл `init.conf` для указания ваших параметров:

```bash
# Пути (относительные к BASE_DIR)
BACKUP_PATHS="/"                         # Пути для резервного копирования
RESTIC_REPOSITORY="/path/to/repo"        # Репозиторий Restic
RESTIC_PASSWORD_FILE=".restic_pass"      # Файл с паролем
RESTIC_CACHE_DIR="cache"                 # Директория кеша
RESTIC_PACK_SIZE="128"                   # Размер пакета (МБ)
EXCLUDE_FILE="exclude.txt"               # Файл с исключениями
LOG_FILE="backup.log"                    # Файл лога

# Настройки хранения
RETENTION_DAYS=14    # Хранить ежедневные снимки за 14 дней
RETENTION_WEEKS=4    # Хранить еженедельные снимки за 4 недели
RETENTION_MONTH=4    # Хранить ежемесячные снимки за 4 месяца
RETENTION_YEAR=2     # Хранить ежегодные снимки за 2 года
```

### 2. Подготовка файлов

Создайте необходимые файлы в корне проекта:

```bash
# Файл с паролем репозитория
echo "ваш_пароль" > .restic_pass
chmod 600 .restic_pass

# Файл с исключениями (опционально)
touch exclude.txt

# Директория для кеша будет создана автоматически
```

## Использование

### Запуск системы

```bash
sudo ./main.sh
```

Скрипт должен запускаться с правами root (проверка встроена).

### Что происходит при запуске

1. **Инициализация**:
   - Определяется базовый каталог (`BASE_DIR`)
   - Загружаются настройки из `init.conf`
   - Формируются абсолютные пути ко всем файлам
   - Создается директория для кеша (если отсутствует)

2. **Резервное копирование** (`run_restic_backup`):
   - Проверяется наличие `restic` в системе
   - Инициализируется репозиторий (если требуется)
   - Выполняется команда `restic backup` с параметрами:
     - `--cache-dir` из конфигурации
     - `--exclude-file` если файл существует
     - `--pack-size` из конфигурации

3. **Очистка старых снимков** (`run_restic_forget`):
   - Выполняется команда `restic forget` с политиками хранения
   - Параметры: `--prune`, `--cache-dir`, `--pack-size`

### Логирование

Все сообщения записываются в файл `backup.log` и выводятся в терминал. Функция `log()` определена в `main.sh` и доступна во всех модулях.

## Особенности реализации

### Безопасность
- Скрипт проверяет запуск от root
- Используются `set -e` и `set -o pipefail` для обработки ошибок
- Пароль хранится в отдельном файле с ограниченными правами

### Переносимость
- Все пути строятся относительно `BASE_DIR`
- Систему можно запускать из любого места или через cron
- Используются массивы Bash для передачи аргументов командам

### Модульность
- Логика разделена на независимые модули
- Общие настройки вынесены в конфигурационный файл
- Главный скрипт управляет зависимостями и порядком выполнения

## Настройка cron

Для автоматического запуска добавьте в crontab:

```bash
# Ежедневный бэкап в 2:00
0 2 * * * cd /путь/к/проекту && sudo ./main.sh
```

## Требования

- Bash 4.0+
- Restic (установите через пакетный менеджер вашего дистрибутива)
- Права root для доступа ко всем файлам системы

## Устранение неполадок

### Ошибка: "restic не найден"
Установите Restic:
```bash
# Ubuntu/Debian
sudo apt install restic

# CentOS/RHEL
sudo yum install restic

# Вручную
wget https://github.com/restic/restic/releases/latest/download/restic_linux_amd64.bz2
bzip2 -d restic_linux_amd64.bz2
chmod +x restic_linux_amd64
sudo mv restic_linux_amd64 /usr/local/bin/restic
```

### Ошибка: "Репозиторий не инициализирован"
Убедитесь, что:
- Указан правильный путь к репозиторию в `init.conf`
- Репозиторий существует или доступен для создания
- Пароль в файле `.restic_pass` соответствует репозиторию

### Ошибка прав доступа
Убедитесь, что:
- Скрипт запущен с правами root
- Файл `.restic_pass` имеет права 600
- Директория кеша доступна для записи

## Лицензия

Проект распространяется под лицензией MIT.
