# Инициализация чеков Healthchecks

Этот скрипт предназначен для автоматического создания чеков в [Healthchecks.io](https://healthchecks.io) на основе конфигурационного файла `init.conf`.

## Назначение

Скрипт `init_checks.py` читает конфигурацию, находит все включённые задачи резервного копирования и создаёт для каждой из них соответствующий чек в Healthchecks. Это позволяет отслеживать выполнение задач резервного копирования и получать уведомления в случае сбоев.

## Требования

- Python 3.9 или выше
- Установленные зависимости:
  - `PyYAML`
  - `requests`

Установите зависимости с помощью pip:

```bash
pip install PyYAML requests
```

## Конфигурация

Перед запуском инициализации необходимо настроить файл `init.conf`. Основные параметры:

### Секция `general`

```yaml
general:
  server_name: "server-01"       # Имя сервера (будет добавлено к slug чеков)
  base_url: "https://hc.t8.ru/api/v1/checks/"   # Базовый URL API Healthchecks
  ping_base: "https://hc.t8.ru/ping/qpljt3jgl2inp8lkya6h1a/"   # Базовый URL для ping-сигналов
  channels: "uuid1,uuid2"        # Идентификаторы каналов уведомлений через запятую
```

### Секция `tasks`

Каждая задача должна содержать:

```yaml
- name: "Postgres Local Main"
  slug: "db-backup-postgres-1"   # Уникальный идентификатор задачи
  tag: "postgres db backup"      # Теги для чеков (через пробел)
  enable: true                   # Включена ли задача для инициализации
```

Остальные параметры задачи (db_type, container_name и т.д.) для инициализации чеков не используются.

## Использование

### 1. Получение API токена

В Healthchecks перейдите в настройки проекта и скопируйте **API ключ** (Read/Write).

### 2. Запуск инициализации

```bash
python3 init_checks.py <API_токен>
```

Опционально можно указать другой базовый URL API:

```bash
python3 init_checks.py <API_токен> --base-url "https://healthchecks.io/api/v1/checks/"
```

### 3. Что происходит при запуске

1. Скрипт загружает конфигурацию из `init.conf`.
2. Извлекает общие настройки (`server_name`, `base_url`, `ping_base`, `channels`).
3. Находит все задачи с `enable: true`.
4. Для каждой задачи:
   - Формирует полный slug в формате `{server_name}-{task_slug}`.
   - Проверяет, существует ли уже чек с таким slug.
   - Если не существует — создаёт новый чек с указанными тегами и каналами.
   - Выводит результат (создан или уже существует) и ping URL.

### 4. Пример вывода

```
Используемый base_url: https://hc.t8.ru/api/v1/checks/
Используемый ping_base: https://hc.t8.ru/ping/qpljt3jgl2inp8lkya6h1a/
Используемые каналы: 319329f7-0060-4219-8fd8-6f8a1d1f2258,abbddf53-8bf5-47bf-bc85-e79d99d08c70
Создание чеков для сервера: server-01
Найдено включённых задач: 3
  Создание чека для задачи: Postgres Local Main (slug: server-01-db-backup-postgres-1, tags: postgres db backup)
    Результат: created
    Ping URL: https://hc.t8.ru/ping/qpljt3jgl2inp8lkya6h1a/server-01-db-backup-postgres-1
  ...
Инициализация завершена.
```

## Структура проекта

- `init_checks.py` — основной скрипт инициализации.
- `config_manager.py` — модуль для работы с конфигурацией `init.conf`.
- `hc.py` — вспомогательные функции для взаимодействия с API Healthchecks.
- `init.conf` — конфигурационный файл (пример).

## Обработка ошибок

- Если файл `init.conf` не найден или содержит синтаксические ошибки YAML, скрипт завершится с сообщением об ошибке.
- Если отсутствует секция `general` или `tasks`, скрипт также завершится с ошибкой.
- При проблемах с сетью или API Healthchecks ошибка будет выведена в stderr, но скрипт продолжит обработку остальных задач.

## Безопасность

- API токен передаётся как аргумент командной строки, что может оставить его в истории команд. Рекомендуется использовать переменные окружения или файлы с ограниченными правами.
- Конфигурационный файл `init.conf` может содержать чувствительные данные (например, URL с ping-токенами). Убедитесь, что права на чтение ограничены.

## Проверка чек-листа (Dangerous Areas Checklist)

Перед запуском в production убедитесь в следующем:

1. **Права и пользователь** — скрипт выполняется от пользователя с доступом к чтению `init.conf` и без излишних привилегий.
2. **Окружение** — убедитесь, что `base_url` и `ping_base` указывают на правильный экземпляр Healthchecks (prod/stage/dev).
3. **Секреты и креды** — API токен не попадает в логи или вывод скрипта.
4. **Ошибки и исключения** — скрипт корректно обрабатывает сетевые сбои и не завершается аварийно для всех задач при единичной ошибке.
5. **Идемпотентность** — повторный запуск безопасен: существующие чеки не будут дублироваться.

## Дальнейшие действия

После успешной инициализации чеков можно настроить задачи резервного копирования для отправки ping-сигналов (start/success/fail) в соответствующие ping URL. Пример использования функций из `hc.py`:

```python
from hc import ping_start, ping_success

ping_url = "https://hc.t8.ru/ping/qpljt3jgl2inp8lkya6h1a/server-01-db-backup-postgres-1"
ping_start(ping_url)
# ... выполнение задачи резервного копирования ...
ping_success(ping_url)
```

---
*Этот документ охватывает только процесс инициализации чеков. Полная документация по настройке резервного копирования находится в других разделах.*
